#![feature(lang_items)]

extern crate libc;
extern crate rustc_serialize;
extern crate postgres;

use std::slice;
use std::str;
use rustc_serialize::json;
use std::collections::BTreeMap;
use std::mem;

use postgres::{Connection, SslMode};
use postgres::rows::Row;

// use std::collections::HashMap;
// use rustc_serialize::json::Json;

#[repr(C)]
pub struct Result {
  len : usize,
  data : *mut i32
}

#[no_mangle]
pub extern "C" fn rust_fetch(id: i32, mut ary: *mut i32) -> *mut Result {

let mut entry = BTreeMap::new();
let conn = Connection::connect("postgres://altmetric-explorer:q6MKRcbPgC4XvxG6hovfwZsV@127.0.0.1:55432", SslMode::None)
            .unwrap();
for row in &conn.query("SELECT research_output_id::integer, ARRAY[coalesce((post_counts->>'')::integer, 0), coalesce((post_counts->>'AD')::integer, 0),coalesce((post_counts->>'AE')::integer, 0),coalesce((post_counts->>'AF')::integer, 0),coalesce((post_counts->>'AG')::integer, 0),coalesce((post_counts->>'AI')::integer, 0),coalesce((post_counts->>'AL')::integer, 0),coalesce((post_counts->>'AM')::integer, 0),coalesce((post_counts->>'AO')::integer, 0),coalesce((post_counts->>'AQ')::integer, 0),coalesce((post_counts->>'AR')::integer, 0),coalesce((post_counts->>'AS')::integer, 0),coalesce((post_counts->>'AT')::integer, 0),coalesce((post_counts->>'AU')::integer, 0),coalesce((post_counts->>'AW')::integer, 0),coalesce((post_counts->>'AX')::integer, 0),coalesce((post_counts->>'AZ')::integer, 0),coalesce((post_counts->>'BA')::integer, 0),coalesce((post_counts->>'BB')::integer, 0),coalesce((post_counts->>'BD')::integer, 0),coalesce((post_counts->>'BE')::integer, 0),coalesce((post_counts->>'BF')::integer, 0),coalesce((post_counts->>'BG')::integer, 0),coalesce((post_counts->>'BH')::integer, 0),coalesce((post_counts->>'BI')::integer, 0),coalesce((post_counts->>'BJ')::integer, 0),coalesce((post_counts->>'BL')::integer, 0),coalesce((post_counts->>'BM')::integer, 0),coalesce((post_counts->>'BN')::integer, 0),coalesce((post_counts->>'BO')::integer, 0),coalesce((post_counts->>'BQ')::integer, 0),coalesce((post_counts->>'BR')::integer, 0),coalesce((post_counts->>'BS')::integer, 0),coalesce((post_counts->>'BT')::integer, 0),coalesce((post_counts->>'BV')::integer, 0),coalesce((post_counts->>'BW')::integer, 0),coalesce((post_counts->>'BY')::integer, 0),coalesce((post_counts->>'BZ')::integer, 0),coalesce((post_counts->>'CA')::integer, 0),coalesce((post_counts->>'CC')::integer, 0),coalesce((post_counts->>'CD')::integer, 0),coalesce((post_counts->>'CF')::integer, 0),coalesce((post_counts->>'CG')::integer, 0),coalesce((post_counts->>'CH')::integer, 0),coalesce((post_counts->>'CI')::integer, 0),coalesce((post_counts->>'CK')::integer, 0),coalesce((post_counts->>'CL')::integer, 0),coalesce((post_counts->>'CM')::integer, 0),coalesce((post_counts->>'CN')::integer, 0),coalesce((post_counts->>'CO')::integer, 0),coalesce((post_counts->>'CR')::integer, 0),coalesce((post_counts->>'CU')::integer, 0),coalesce((post_counts->>'CV')::integer, 0),coalesce((post_counts->>'CW')::integer, 0),coalesce((post_counts->>'CX')::integer, 0),coalesce((post_counts->>'CY')::integer, 0),coalesce((post_counts->>'CZ')::integer, 0),coalesce((post_counts->>'DE')::integer, 0),coalesce((post_counts->>'DJ')::integer, 0),coalesce((post_counts->>'DK')::integer, 0),coalesce((post_counts->>'DM')::integer, 0),coalesce((post_counts->>'DO')::integer, 0),coalesce((post_counts->>'DZ')::integer, 0),coalesce((post_counts->>'EC')::integer, 0),coalesce((post_counts->>'EE')::integer, 0),coalesce((post_counts->>'EG')::integer, 0),coalesce((post_counts->>'EH')::integer, 0),coalesce((post_counts->>'ER')::integer, 0),coalesce((post_counts->>'ES')::integer, 0),coalesce((post_counts->>'ET')::integer, 0),coalesce((post_counts->>'FI')::integer, 0),coalesce((post_counts->>'FJ')::integer, 0),coalesce((post_counts->>'FK')::integer, 0),coalesce((post_counts->>'FM')::integer, 0),coalesce((post_counts->>'FO')::integer, 0),coalesce((post_counts->>'FR')::integer, 0),coalesce((post_counts->>'GA')::integer, 0),coalesce((post_counts->>'GB')::integer, 0),coalesce((post_counts->>'GD')::integer, 0),coalesce((post_counts->>'GE')::integer, 0),coalesce((post_counts->>'GF')::integer, 0),coalesce((post_counts->>'GG')::integer, 0),coalesce((post_counts->>'GH')::integer, 0),coalesce((post_counts->>'GI')::integer, 0),coalesce((post_counts->>'GL')::integer, 0),coalesce((post_counts->>'GM')::integer, 0),coalesce((post_counts->>'GN')::integer, 0),coalesce((post_counts->>'GP')::integer, 0),coalesce((post_counts->>'GQ')::integer, 0),coalesce((post_counts->>'GR')::integer, 0),coalesce((post_counts->>'GS')::integer, 0),coalesce((post_counts->>'GT')::integer, 0),coalesce((post_counts->>'GU')::integer, 0),coalesce((post_counts->>'GW')::integer, 0),coalesce((post_counts->>'GY')::integer, 0),coalesce((post_counts->>'HK')::integer, 0),coalesce((post_counts->>'HM')::integer, 0),coalesce((post_counts->>'HN')::integer, 0),coalesce((post_counts->>'HR')::integer, 0),coalesce((post_counts->>'HT')::integer, 0),coalesce((post_counts->>'HU')::integer, 0),coalesce((post_counts->>'ID')::integer, 0),coalesce((post_counts->>'IE')::integer, 0),coalesce((post_counts->>'IL')::integer, 0),coalesce((post_counts->>'IM')::integer, 0),coalesce((post_counts->>'IN')::integer, 0),coalesce((post_counts->>'IO')::integer, 0),coalesce((post_counts->>'IQ')::integer, 0),coalesce((post_counts->>'IR')::integer, 0),coalesce((post_counts->>'IS')::integer, 0),coalesce((post_counts->>'IT')::integer, 0),coalesce((post_counts->>'JE')::integer, 0),coalesce((post_counts->>'JM')::integer, 0),coalesce((post_counts->>'JO')::integer, 0),coalesce((post_counts->>'JP')::integer, 0),coalesce((post_counts->>'KE')::integer, 0),coalesce((post_counts->>'KG')::integer, 0),coalesce((post_counts->>'KH')::integer, 0),coalesce((post_counts->>'KI')::integer, 0),coalesce((post_counts->>'KM')::integer, 0),coalesce((post_counts->>'KN')::integer, 0),coalesce((post_counts->>'KP')::integer, 0),coalesce((post_counts->>'KR')::integer, 0),coalesce((post_counts->>'KW')::integer, 0),coalesce((post_counts->>'KY')::integer, 0),coalesce((post_counts->>'KZ')::integer, 0),coalesce((post_counts->>'LA')::integer, 0),coalesce((post_counts->>'LB')::integer, 0),coalesce((post_counts->>'LC')::integer, 0),coalesce((post_counts->>'LI')::integer, 0),coalesce((post_counts->>'LK')::integer, 0),coalesce((post_counts->>'LR')::integer, 0),coalesce((post_counts->>'LS')::integer, 0),coalesce((post_counts->>'LT')::integer, 0),coalesce((post_counts->>'LU')::integer, 0),coalesce((post_counts->>'LV')::integer, 0),coalesce((post_counts->>'LY')::integer, 0),coalesce((post_counts->>'MA')::integer, 0),coalesce((post_counts->>'MC')::integer, 0),coalesce((post_counts->>'MD')::integer, 0),coalesce((post_counts->>'ME')::integer, 0),coalesce((post_counts->>'MF')::integer, 0),coalesce((post_counts->>'MG')::integer, 0),coalesce((post_counts->>'MH')::integer, 0),coalesce((post_counts->>'MK')::integer, 0),coalesce((post_counts->>'ML')::integer, 0),coalesce((post_counts->>'MM')::integer, 0),coalesce((post_counts->>'MN')::integer, 0),coalesce((post_counts->>'MO')::integer, 0),coalesce((post_counts->>'MP')::integer, 0),coalesce((post_counts->>'MQ')::integer, 0),coalesce((post_counts->>'MR')::integer, 0),coalesce((post_counts->>'MS')::integer, 0),coalesce((post_counts->>'MT')::integer, 0),coalesce((post_counts->>'MU')::integer, 0),coalesce((post_counts->>'MV')::integer, 0),coalesce((post_counts->>'MW')::integer, 0),coalesce((post_counts->>'MX')::integer, 0),coalesce((post_counts->>'MY')::integer, 0),coalesce((post_counts->>'MZ')::integer, 0),coalesce((post_counts->>'NA')::integer, 0),coalesce((post_counts->>'NC')::integer, 0),coalesce((post_counts->>'NE')::integer, 0),coalesce((post_counts->>'NF')::integer, 0),coalesce((post_counts->>'NG')::integer, 0),coalesce((post_counts->>'NI')::integer, 0),coalesce((post_counts->>'NL')::integer, 0),coalesce((post_counts->>'NO')::integer, 0),coalesce((post_counts->>'NP')::integer, 0),coalesce((post_counts->>'NR')::integer, 0),coalesce((post_counts->>'NU')::integer, 0),coalesce((post_counts->>'NZ')::integer, 0),coalesce((post_counts->>'OM')::integer, 0),coalesce((post_counts->>'PA')::integer, 0),coalesce((post_counts->>'PE')::integer, 0),coalesce((post_counts->>'PF')::integer, 0),coalesce((post_counts->>'PG')::integer, 0),coalesce((post_counts->>'PH')::integer, 0),coalesce((post_counts->>'PK')::integer, 0),coalesce((post_counts->>'PL')::integer, 0),coalesce((post_counts->>'PM')::integer, 0),coalesce((post_counts->>'PN')::integer, 0),coalesce((post_counts->>'PS')::integer, 0),coalesce((post_counts->>'PT')::integer, 0),coalesce((post_counts->>'PW')::integer, 0),coalesce((post_counts->>'PY')::integer, 0),coalesce((post_counts->>'QA')::integer, 0),coalesce((post_counts->>'RE')::integer, 0),coalesce((post_counts->>'RO')::integer, 0),coalesce((post_counts->>'RS')::integer, 0),coalesce((post_counts->>'RU')::integer, 0),coalesce((post_counts->>'RW')::integer, 0),coalesce((post_counts->>'SA')::integer, 0),coalesce((post_counts->>'SB')::integer, 0),coalesce((post_counts->>'SC')::integer, 0),coalesce((post_counts->>'SD')::integer, 0),coalesce((post_counts->>'SE')::integer, 0),coalesce((post_counts->>'SG')::integer, 0),coalesce((post_counts->>'SH')::integer, 0),coalesce((post_counts->>'SI')::integer, 0),coalesce((post_counts->>'SJ')::integer, 0),coalesce((post_counts->>'SK')::integer, 0),coalesce((post_counts->>'SL')::integer, 0),coalesce((post_counts->>'SM')::integer, 0),coalesce((post_counts->>'SN')::integer, 0),coalesce((post_counts->>'SO')::integer, 0),coalesce((post_counts->>'SR')::integer, 0),coalesce((post_counts->>'SS')::integer, 0),coalesce((post_counts->>'ST')::integer, 0),coalesce((post_counts->>'SV')::integer, 0),coalesce((post_counts->>'SX')::integer, 0),coalesce((post_counts->>'SY')::integer, 0),coalesce((post_counts->>'SZ')::integer, 0),coalesce((post_counts->>'TC')::integer, 0),coalesce((post_counts->>'TD')::integer, 0),coalesce((post_counts->>'TF')::integer, 0),coalesce((post_counts->>'TG')::integer, 0),coalesce((post_counts->>'TH')::integer, 0),coalesce((post_counts->>'TJ')::integer, 0),coalesce((post_counts->>'TK')::integer, 0),coalesce((post_counts->>'TL')::integer, 0),coalesce((post_counts->>'TM')::integer, 0),coalesce((post_counts->>'TN')::integer, 0),coalesce((post_counts->>'TO')::integer, 0),coalesce((post_counts->>'TR')::integer, 0),coalesce((post_counts->>'TT')::integer, 0),coalesce((post_counts->>'TV')::integer, 0),coalesce((post_counts->>'TW')::integer, 0),coalesce((post_counts->>'TZ')::integer, 0),coalesce((post_counts->>'UA')::integer, 0),coalesce((post_counts->>'UG')::integer, 0),coalesce((post_counts->>'UM')::integer, 0),coalesce((post_counts->>'US')::integer, 0),coalesce((post_counts->>'UY')::integer, 0),coalesce((post_counts->>'UZ')::integer, 0),coalesce((post_counts->>'VA')::integer, 0),coalesce((post_counts->>'VC')::integer, 0),coalesce((post_counts->>'VE')::integer, 0),coalesce((post_counts->>'VG')::integer, 0),coalesce((post_counts->>'VI')::integer, 0),coalesce((post_counts->>'VN')::integer, 0),coalesce((post_counts->>'VU')::integer, 0),coalesce((post_counts->>'WF')::integer, 0),coalesce((post_counts->>'WS')::integer, 0),coalesce((post_counts->>'YE')::integer, 0),coalesce((post_counts->>'YT')::integer, 0),coalesce((post_counts->>'ZA')::integer, 0),coalesce((post_counts->>'ZM')::integer, 0),coalesce((post_counts->>'ZW')::integer, 0)] FROM \"country_counts\"", &[]).unwrap() {
    let id: i32 = row.get(0);
    let data: Vec<i32> = row.get(1);
    entry.insert(id, data);
}
  // let s = unsafe {
  //     let slice = slice::from_raw_parts(json, len);
  //     str::from_utf8(slice)
  // };

  // //100004\
  // let json : BTreeMap<String, Vec<i32>> = json::decode(s.unwrap()).unwrap();
  // json.len()
  // entry.len()
  let mut res = entry.get_mut(&id).unwrap();
  unsafe { mem::transmute(Box::new(Result { len: res.len(), data: res.as_mut_ptr() })) }
}

#[no_mangle]
pub extern "C" fn fasthash_init() { }
